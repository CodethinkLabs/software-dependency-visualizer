<!doctype html>

<!-- This is a prototype of a 'software dependency visualiser' tool.

     Hacks abound. Read through this file to discover what would need
     doing to make this into more than a prototype.
-->

<html>
<head>
  <meta charset="utf-8">

  <title>Software dependency visualiser PROTOTYPE</title>

  <!-- JQuery library: required by w2ui -->
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>

  <!-- w2ui: user interface library. We use this just for the paned layout. -->
  <!-- FIXME: should we just use browser <frame> oldskool style instead of that? -->
  <link rel="stylesheet" type="text/css" href="bower_components/w2ui/w2ui-1.4.3.min.css" />
  <script type="text/javascript" src="bower_components/w2ui/w2ui-1.4.3.min.js"></script>

  <!-- DotGraph: used to parse Graphviz .dot inputs.
        That functionality should probably move server-side at some point.
        From: <https://github.com/siefkenj/dotgraph>
    -->
  <script type="text/javascript" src="bower_components/dotgraph/js/dotgraph.js"></script>
  <script type="text/javascript" src="bower_components/dotgraph/js/dotparser.js"></script>

  <!-- D3: data visualisation toolkit. -->
  <script type="text/javascript" src="bower_components/d3/d3.min.js"></script>

  <!-- software-dependency-explorer components -->
  <script type="text/javascript" src="browser.js"></script>
  <script type="text/javascript" src="graph.js"></script>
  <script type="text/javascript" src="model.js"></script>
</head>

<body>
  <div id="browser" style="width: 100%; float: right;">
      <!-- This is implemented as HTML and this part of the page should work
           when Javascript isn't enabled, i.e. it should be populated server
           side. Once there *is* a server side.
        -->
      <p>
      Name: <span id="name"><i>none</i></span>
      </p>

      <p>
      Requires: <span id="requires"><i>none</i></span>
      </p>

      <p>
      Required by: <span id="required-by"><i>none</i></span>
      </p>
  </div>

  <div id="layout" style="width: 100%; height: 600px; display: none;">
    <!-- This will be filled with the w2ui paned layout, and made visible. -->
  </div>

  <div id="graph-source" style="display: none;">
    <!-- Graph soure code is fetched here.
         The jQuery $.load() object only allows fetching data into a DOM
         element.
      -->
  </div>

  <svg id="graph-visualisation" style="width: 100%; height: 100%;"></svg>
</body>

<script>

// Get a ? query parameter from the URL.
// From: https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript/5158301#5158301
function getParameterByName(name) {
    var match = RegExp('[?&]' + name + '=([^&]*)').exec(window.location.search);
    return match && decodeURIComponent(match[1].replace(/\+/g, ' '));
}

DEFAULT_FOCUS = "bde";

// Main function, called on page load.
$(function() {
    setup_layout();

    var model = new Model();

    var browser = new Browser(model, "#browser");
    // We can't do much with the browser client-side until the data is loaded

    var graph = new Graph(model, "#graph-visualisation");
    // We can't render the graph yet, so add some "loading" text.
    graph.show_loading_text("Loading graph...");

    // Load the graphviz data into a hidden <div> element. This sucks and is
    // one of the many reasons we should do the graph processing server-side.
    $("#graph-source").load("dpkg-declared-deps.dot", function() {
        var dotgraph_ast = DotParser.parse($("#graph-source").text());
        var dotgraph_graph = new DotGraph(dotgraph_ast);
        dotgraph_graph.walk();
        model.import_from_dotgraph(dotgraph_graph);

        var focus_component = getParameterByName("focus") || DEFAULT_FOCUS;
        browser.show_component(focus_component);

        graph.setup_visualisation();
        graph.hide_loading_text();
    });
});

// Called on page load
function setup_layout() {
    var pstyle = 'background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;';
    $('#layout').w2layout({
        name: 'layout',
        panels: [
            { type: 'left', size: 400, resizable: true, style: pstyle },
        ],
        resizer: 6
    });

    w2ui.layout.content('left', $('#graph-visualisation').get());
    w2ui.layout.content('main', $('#browser').get());
    $('#layout').show();
};

</script>

</html>
