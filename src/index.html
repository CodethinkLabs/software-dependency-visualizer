<!doctype html>

<!-- This is a prototype of a 'software dependency visualiser' tool.

     Hacks abound. Read through this file to discover what would need
     doing to make this into more than a prototype.
-->

<html>
<head>
  <meta charset="utf-8">

  <title>Software dependency visualiser PROTOTYPE</title>

  <!-- JQuery library: required by w2ui -->
  <script type="text/javascript" src="bower_components/jquery/dist/jquery.min.js"></script>

  <!-- w2ui: user interface library. We use this just for the paned layout. -->
  <link rel="stylesheet" type="text/css" href="bower_components/w2ui/w2ui-1.4.3.min.css" />
  <script type="text/javascript" src="bower_components/w2ui/w2ui-1.4.3.min.js"></script>

  <!-- DotGraph: used to parse Graphviz .dot inputs.
                 that functionality should probably move server-side at some point. -->
  <script type="text/javascript" src="bower_components/dotgraph/js/dotgraph.js"></script>
  <script type="text/javascript" src="bower_components/dotgraph/js/dotparser.js"></script>

  <!-- D3: data visualisation toolkit. -->
  <script type="text/javascript" src="bower_components/d3/d3.min.js"></script>

  <!-- software-dependency-explorer components -->
  <script type="text/javascript" src="graph.js"></script>
</head>

<body>
  <div id="panel-right" style="width: 100%; float: right;">
      <!-- This is implemented as HTML and this part of the page should work
           when Javascript isn't enabled.
        -->
      I'm the <i>stuff on the right...............</i>
  </div>

  <div id="layout" style="width: 100%; height: 600px; display: none;">
    <!-- This will be filled with the w2ui paned layout, and made visible. -->
  </div>

  <div id="graph-source" style="display: none;">
    <!-- Graph soure code is fetched here.
         The jQuery $.load() object only allows fetching data into a DOM
         element.
      -->
  </div>

  <svg id="graph-visualisation" style="width: 100%; height: 100%;"></svg>
</body>

<script>

// Main function, called on page load.
$(function() {
    setup_layout();

    var graph = new Graph("#graph-visualisation");

    // We can't render the graph yet, so add some "loading" text.
    graph.show_loading_text("Loading graph...");

    // Load the graphviz data into a hidden <div> element. This sucks and is
    // one of the many reasons we should do the graph processing server-side.
    $("#graph-source").load("dpkg-declared-deps.dot", function() {
        setup_graph_visualisation(graph, $("#graph-source").text());
    });
});

// Called on page load
function setup_layout() {
    var pstyle = 'background-color: #F5F6F7; border: 1px solid #dfdfdf; padding: 5px;';
    $('#layout').w2layout({
        name: 'layout',
        panels: [
            { type: 'left', size: 200, resizable: true, style: pstyle },
        ],
        resizer: 6
    });

    w2ui.layout.content('left', $('#graph-visualisation').get());
    w2ui.layout.content('main', $('#panel-right').get());
    $('#layout').show();
};

// Called once the graphviz source text has been loaded.
function setup_graph_visualisation(graph, graphviz_text) {
    var dotgraph_ast = DotParser.parse(graphviz_text);
    var dotgraph_graph = new DotGraph(dotgraph_ast);

    dotgraph_graph.walk();

    graph.load_from_dotgraph(dotgraph_graph);

    var svg = d3.select("#graph-visualisation");

    var force = d3.layout.force()
        .nodes(graph.nodes)
        .links(graph.edges)
        .size([$("#graph-visualisation").width(),
               $("#graph-visualisation").height()]);

    // The initial render is done in a further timeout, to avoid
    // blocking for a long time.
    // This is based on: http://bl.ocks.org/mbostock/1667139
    setTimeout(function() {
      // Run the layout a fixed number of times.
      // The ideal number of times scales with graph complexity.
      // Of course, don't run too longâ€”you'll hang the page!
      var n = 100;
      force.start();
      for (var i = n * n; i > 0; --i) force.tick();
      force.stop();

      svg.selectAll("line")
          .data(graph.edges)
        .enter().append("line")
          .attr("x1", function(d) { return d.source.x; })
          .attr("y1", function(d) { return d.source.y; })
          .attr("x2", function(d) { return d.target.x; })
          .attr("y2", function(d) { return d.target.y; });

      svg.selectAll("circle")
          .data(graph.nodes)
        .enter().append("circle")
          .attr("cx", function(d) { return d.x; })
          .attr("cy", function(d) { return d.y; })
          .attr("r", 4.5);

        console.log("Rendering complete")

        graph.hide_loading_text();
    }, 10);
}

</script>

</html>
